<!DOCTYPE html>
<html lang="en" ng-app="a2aDemoApp">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A2A Demo Interface</title>

  <!-- AngularJS + sanitize -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-sanitize.min.js"></script>

  <!-- A2AClient as ES module -->
  <script type="module">
    import { A2AClient } from './a2a-client.js';
    window.A2AClient = A2AClient;
  </script>

  <!-- Inline UUID generator (no external CDN) -->
  <script>
    // RFC4122-compliant v4 UUID generator
    window.uuidv4 = function() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };
  </script>

  <!-- Refactored chat logic -->
  <script src="app.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:20px; max-width:600px; }
    .chat-window { border: 1px solid #ccc; padding:10px; height:300px; overflow-y:auto; }
    .message { margin-bottom:8px; }
    .message.user   { text-align: right; }
    .message.agent  { text-align: left; }
    .loading { font-style: italic; color: #666; }
    pre { background:#f9f9f9; padding:8px; overflow-x:auto; }
    img { max-width:100%; height:auto; display:block; margin-top:8px; }
    .artifact { border-top:1px solid #eee; margin-top:12px; padding-top:8px; }
  </style>
</head>

<body ng-controller="ChatController">
  <h1>A2A Demo UI</h1>

  <div class="chat-window">
    <!-- Finalized messages -->
    <div ng-repeat="msg in messages" class="message {{msg.sender}}">
      <strong ng-if="msg.sender==='user'">You:</strong>
      <strong ng-if="msg.sender==='assistant'">Assistant:</strong>
      <span ng-if="msg.sender==='user'">{{msg.content}}</span>
      <span ng-if="msg.sender==='assistant'" ng-bind-html="msg.content"></span>
    </div>

    <!-- Streaming in-progress reply -->
    <div class="message agent" ng-if="streamingReply">
      <strong>Assistant:</strong>
      <span ng-bind-html="trustMarkdown(streamingReply)"></span>
    </div>

    <!-- Artifact (JSON/text/binary) -->
    <div class="artifact" ng-if="artifact">
      <h4>Artifact:</h4>
      <div ng-switch="artifact.type">
        <pre ng-switch-when="json">{{artifact.raw}}</pre>
        <pre ng-switch-when="text">{{artifact.raw}}</pre>
        <div ng-switch-when="binary">
          <a ng-href="{{createObjectURL(artifact.blob)}}"
             download="{{artifact.name}}">
            📎 Download {{artifact.name}}
          </a>
          <img ng-if="artifact.blob.type.startsWith('image/')"
               ng-src="{{createObjectURL(artifact.blob)}}"
               alt="Image Artifact"/>
        </div>
      </div>
    </div>

    <!-- “typing…” indicator -->
    <div class="loading" ng-if="loading">Assistant is typing…</div>
  </div>

  <form ng-submit="sendMessage()" style="margin-top:12px;">
    <input type="text" ng-model="userInput"
           placeholder="Type a message…" style="width:80%;" required />
    <button type="submit">Send</button>
  </form>
</body>
</html>
